<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automação Predial - Gerenciamento de Água</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Flatpickr (Calendário) CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap');
        :root { font-family: 'Inter', sans-serif; }
        html, body { height: 100%; margin: 0; }
        
        /* Efeito de fundo animado */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0c4a6e, #1e3a8a, #0d9488);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            opacity: 0.8;
            z-index: -1;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Efeito de "glow" em cards ativos */
        .status-glow {
            box-shadow: 0 0 10px #38bdf8, 0 0 20px #22d3ee;
            transition: box-shadow 0.5s ease-in-out;
        }
        .status-red-glow {
             box-shadow: 0 0 10px #f87171, 0 0 20px #ef4444;
        }

        /* Efeito de movimento para o ícone de gota */
        .water-icon { animation: pulse-bounce 2s infinite ease-in-out; }
        @keyframes pulse-bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1) translateY(-5px); }
        }
        
        /* Estilos para elementos desabilitados */
        .disabled-element, button:disabled, input[type="checkbox"]:disabled + div {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Animação suave para a barra de água */
        #water-level-bar {
            transition: width 1.5s ease-in-out, background-color 1.5s ease;
        }
        
        /* Custom Flatpickr Dark Theme */
        .flatpickr-calendar {
            background: #1f2937;
            border-color: #4b5563;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .flatpickr-months .flatpickr-month,
        .flatpickr-current-month .flatpickr-monthDropdown-months,
        .flatpickr-current-month .numInputWrapper {
            color: #d1d5db; fill: #d1d5db;
        }
        .flatpickr-months .flatpickr-prev-month,
        .flatpickr-months .flatpickr-next-month {
            fill: #9ca3af;
        }
        .flatpickr-months .flatpickr-prev-month:hover,
        .flatpickr-months .flatpickr-next-month:hover {
            fill: #3b82f6;
        }
        .flatpickr-weekday {
            color: #9ca3af;
            font-weight: bold;
        }
        .flatpickr-day {
            color: #d1d5db;
        }
        .flatpickr-day:hover {
            background: #374151;
        }
        .flatpickr-day.today {
            border-color: #3b82f6;
        }
        .flatpickr-day.selected,
        .flatpickr-day.startRange,
        .flatpickr-day.endRange {
            background: #3b82f6; border-color: #3b82f6; color: #fff;
        }
        .flatpickr-day.disabled,
        .flatpickr-day.flatpickr-disabled {
            color: #4b5563; cursor: not-allowed;
        }
        .flatpickr-day.nextMonthDay,
        .flatpickr-day.prevMonthDay {
            color: #6b7280;
        }
        .flatpickr-day.nextMonthDay:hover,
        .flatpickr-day.prevMonthDay:hover {
            background: none;
            cursor: default;
        }
        .flatpickr-time {
            border-top: 1px solid #4b5563;
        }
        .flatpickr-time .numInputWrapper span:hover {
            background: #374151;
        }
        .flatpickr-time .flatpickr-time-separator,
        .flatpickr-time .flatpickr-am-pm {
            color: #d1d5db;
        }
        .numInput.flatpickr-hour, .numInput.flatpickr-minute {
            background: transparent; color: #fff; font-weight: bold;
        }
        
        /* CORREÇÃO: Esconde o ícone de "ver senha" padrão do Edge */
        input[type="password"]::-ms-reveal {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 transition-colors duration-500">
    <!-- Botão de Alternar Tema (Modo Escuro/Claro) -->
    <button id="theme-toggle" class="absolute top-4 right-4 z-40 p-2 rounded-full shadow-md hover:scale-110 transition-transform duration-300 bg-gray-800 text-white dark:bg-gray-200 dark:text-gray-800">
        <svg id="sun-icon" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M6.34 17.66l-1.41 1.41"/><path d="M19.07 4.93l-1.41 1.41"/></svg>
        <svg id="moon-icon" class="w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
    </button>

    <!-- Container Principal da Aplicação -->
    <div id="app-container" class="min-h-screen w-screen flex items-center justify-center font-sans relative overflow-auto p-4 md:p-8">
        
        <!-- Tela de Login -->
        <div id="login-screen" class="z-10 p-8 md:p-12 rounded-3xl shadow-2xl max-w-sm w-full mx-4 transform transition-all duration-500 bg-gray-800 bg-opacity-80 backdrop-blur-md dark:bg-gray-200 dark:bg-opacity-80">
            <div class="text-center mb-6">
                <div class="flex items-center justify-center space-x-4 mb-4">
                    <svg class="text-blue-500 w-16 h-16 water-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.32 0z"/></svg>
                    <h1 class="text-3xl font-extrabold text-white dark:text-gray-800">Automação Predial</h1>
                </div>
                <p class="text-sm font-medium text-gray-400 dark:text-gray-600">Sistema de Gerenciamento de Água</p>
                <p class="text-xs font-medium text-gray-500 dark:text-gray-500 mt-2">Uma solução da Equipe Caminhos D'água</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-300 dark:text-gray-700">Usuário</label>
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <input type="text" id="username-input" class="w-full pl-10 pr-3 py-2 border border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white dark:bg-gray-300 dark:text-gray-900" placeholder="Digite o usuário" />
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-300 dark:text-gray-700">Senha</label>
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        <input type="password" id="password-input" class="w-full pl-10 pr-12 py-2 border border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white dark:bg-gray-300 dark:text-gray-900" placeholder="Digite a senha" />
                        <button type="button" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors duration-200 show-password-btn">
                            <svg class="w-5 h-5 show-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg class="w-5 h-5 hidden hide-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6 18a14.72 14.72 0 0 1-4-6c0-1.01.24-2.07.67-3.11"/><path d="M18.51 16.92A9.03 9.03 0 0 1 12 19c-7 0-10-7-10-7a11.64 11.64 0 0 1 1.74-2.82"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                        </button>
                    </div>
                </div>
                <p id="login-error" class="text-red-400 text-sm font-semibold text-center hidden"></p>
                <button type="submit" class="w-full py-3 rounded-xl font-bold text-white shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-700 hover:to-cyan-600">
                    Entrar
                </button>
                <a href="#" id="show-register-btn" class="block text-center text-sm font-bold text-gray-400 hover:text-blue-400 transition-colors duration-300">
                    Não tem uma conta? Crie uma aqui.
                </a>
            </form>
        </div>

        <!-- Tela de Cadastro -->
        <div id="register-screen" class="hidden z-10 p-8 md:p-12 rounded-3xl shadow-2xl max-w-sm w-full mx-4 transform transition-all duration-500 bg-gray-800 bg-opacity-80 backdrop-blur-md dark:bg-gray-200 dark:bg-opacity-80">
            <div class="text-center mb-6">
                 <div class="flex items-center justify-center space-x-4 mb-4">
                    <svg class="text-blue-500 w-16 h-16 water-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.32 0z"/></svg>
                    <h1 class="text-3xl font-extrabold text-white dark:text-gray-800">Criar Conta</h1>
                </div>
                <p class="text-sm font-medium text-gray-400 dark:text-gray-600">Preencha os dados para se registrar.</p>
            </div>
            <form id="register-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-300 dark:text-gray-700">Usuário</label>
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <input type="text" id="register-username-input" class="w-full pl-10 pr-3 py-2 border border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white dark:bg-gray-300 dark:text-gray-900" placeholder="Crie um usuário" />
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-300 dark:text-gray-700">Senha</label>
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        <input type="password" id="register-password-input" class="w-full pl-10 pr-12 py-2 border border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white dark:bg-gray-300 dark:text-gray-900" placeholder="Crie uma senha" />
                        <span id="password-valid-icon" class="absolute right-4 top-1/2 -translate-y-1/2"></span>
                    </div>
                </div>
                <!-- Requisitos da Senha -->
                <div id="password-requirements" class="text-xs space-y-1 hidden p-3 bg-gray-700 rounded-lg">
                    <p id="req-length" class="text-red-400 flex items-center"><span class="mr-2">✗</span> Mínimo 8 caracteres</p>
                    <p id="req-uppercase" class="text-red-400 flex items-center"><span class="mr-2">✗</span> Uma letra maiúscula</p>
                    <p id="req-lowercase" class="text-red-400 flex items-center"><span class="mr-2">✗</span> Uma letra minúscula</p>
                    <p id="req-number" class="text-red-400 flex items-center"><span class="mr-2">✗</span> Um número</p>
                    <p id="req-special" class="text-red-400 flex items-center"><span class="mr-2">✗</span> Um caractere especial (!@#$%^&*)</p>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-300 dark:text-gray-700">Repetir Senha</label>
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        <input type="password" id="register-password-confirm-input" class="w-full pl-10 pr-12 py-2 border border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white dark:bg-gray-300 dark:text-gray-900" placeholder="Repita a senha" />
                        <span id="password-match-icon" class="absolute right-4 top-1/2 -translate-y-1/2"></span>
                    </div>
                </div>
                 <div>
                    <label class="block text-sm font-bold mb-1 text-gray-300 dark:text-gray-700">Token de Segurança</label>
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 22V5.5C5 4.34 5.94 3.3 7.1 3.3h9.8C18.06 3.3 19 4.34 19 5.5V22l-7-3.5-7 3.5Z"/></svg>
                        <input type="password" id="register-token-input" class="w-full pl-10 pr-3 py-2 border border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white dark:bg-gray-300 dark:text-gray-900" placeholder="Digite o token" />
                    </div>
                </div>
                <p id="register-error" class="text-red-400 text-sm font-semibold text-center hidden"></p>
                <button type="submit" id="register-submit-btn" class="w-full py-3 rounded-xl font-bold text-white shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-700 hover:to-cyan-600">
                    Cadastrar
                </button>
                <a href="#" id="show-login-btn" class="block text-center text-sm font-bold text-gray-400 hover:text-blue-400 transition-colors duration-300">
                    Já tem uma conta? Voltar para o login.
                </a>
            </form>
        </div>


        <!-- Tela do Dashboard -->
        <div id="dashboard-screen" class="hidden z-10 w-full max-w-7xl mx-auto h-full md:h-auto md:min-h-screen flex flex-col pt-12 pb-8">
            <header class="flex-shrink-0 flex flex-col md:flex-row items-center justify-between mb-8 p-6 rounded-3xl shadow-2xl bg-gray-800 bg-opacity-80 backdrop-blur-md dark:bg-gray-200 dark:bg-opacity-80">
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <svg class="text-blue-500 w-12 h-12 water-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.32 0z"/></svg>
                    <h1 class="text-3xl font-extrabold text-white dark:text-gray-800">Automação Predial</h1>
                </div>
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <div id="connection-status" class="flex items-center space-x-2 p-2 rounded-full font-bold text-sm">
                        <span id="connection-dot" class="w-3 h-3 rounded-full animate-pulse"></span>
                        <span id="connection-text">Conexão...</span>
                    </div>

                    <p id="datetime-display" class="text-xl font-semibold text-white dark:text-gray-800"></p>
                    <button id="view-logs-btn" class="py-2 px-4 rounded-xl font-bold text-white shadow-lg transition-all duration-300 transform hover:scale-105 bg-blue-600 hover:bg-blue-700">
                        Ver Logs
                    </button>
                    <button id="settings-btn" class="p-2 rounded-full shadow-lg transition-all duration-300 transform hover:scale-110 bg-gray-700 hover:bg-gray-600">
                        <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    </button>
                </div>
            </header>
            
            <main class="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Painel de Status Principal -->
                <div class="lg:col-span-2 p-8 rounded-3xl shadow-2xl bg-gray-800 bg-opacity-80 backdrop-blur-md dark:bg-gray-200 dark:bg-opacity-80">
                    <div>
                        <h2 class="text-3xl font-bold mb-6 text-white dark:text-gray-800">Status do Sistema</h2>
                        <div class="mb-8">
                            <p class="text-lg font-semibold mb-2 text-gray-300 dark:text-gray-700">Nível da Água na Caixa</p>
                            <div class="w-full h-10 bg-gray-700 rounded-full overflow-hidden relative shadow-inner dark:bg-gray-300">
                                <div id="water-level-bar" class="h-full rounded-full bg-gradient-to-r from-blue-500 to-cyan-400"></div>
                                <span id="nivelAgua" class="absolute inset-0 flex items-center justify-center text-white font-black text-lg">0%</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                            <div id="pump-status-card" class="p-6 rounded-2xl shadow-lg transition-all duration-300 transform hover:scale-105 bg-gray-700 dark:bg-gray-300">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <p class="text-sm font-bold text-gray-400 dark:text-gray-700">Status da Bomba</p>
                                        <p id="statusBomba" class="text-xl font-bold text-red-500 dark:text-red-600">DESLIGADA</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="toggleBomba" class="sr-only peer" />
                                        <div class="w-14 h-8 bg-red-600 rounded-full peer peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-600 peer-checked:after:translate-x-full"></div>
                                    </label>
                                </div>
                            </div>
                            <div id="valve-status-card" class="p-6 rounded-2xl shadow-lg transition-all duration-300 transform hover:scale-105 bg-gray-700 dark:bg-gray-300">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <p class="text-sm font-bold text-gray-400 dark:text-gray-700">Registro de Entrada</p>
                                        <p id="statusRegistro" class="text-xl font-bold text-red-500">FECHADO</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="toggleRegistro" class="sr-only peer"/>
                                        <div class="w-14 h-8 bg-red-600 rounded-full peer peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-600 peer-checked:after:translate-x-full"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="flow-status-card" class="mb-8 p-6 rounded-2xl shadow-lg flex items-center justify-between bg-gray-700 dark:bg-gray-300">
                            <div class="flex items-center space-x-3">
                                <span id="flow-dot" class="w-4 h-4 rounded-full bg-red-500"></span>
                                <div>
                                    <p class="text-sm font-bold text-gray-400 dark:text-gray-700">Fluxo de Água</p>
                                    <p id="flow-text" class="text-xl font-bold text-red-400 dark:text-red-600">NÃO DETECTADO</p>
                                </div>
                            </div>
                        </div>

                        <div id="maintenance-mode-card" class="p-6 rounded-2xl shadow-lg transition-all duration-300 transform hover:scale-[1.01] bg-gray-700 dark:bg-gray-300">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="flex items-center space-x-2 mb-1">
                                        <svg class="text-gray-400 w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-3.78 3.78a1 1 0 0 1-1.4 0L6.3 14.7a1 1 0 0 1 0-1.4l.7-.7zm-1.4 1.4L11 9.7"/></svg>
                                        <p class="text-sm font-bold text-gray-400 dark:text-gray-700">Modo de Manutenção</p>
                                    </div>
                                    <p id="maintenance-mode-text" class="text-xl font-bold text-gray-400 dark:text-gray-600">DESLIGADO</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="maintenance-toggle" class="sr-only peer" />
                                    <div class="w-14 h-8 bg-gray-600 rounded-full peer peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 dark:peer-focus:ring-red-800 after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-red-600 peer-checked:after:translate-x-full"></div>
                                </label>
                            </div>
                            <div id="maintenance-controls" class="mt-4 hidden flex-col sm:flex-row gap-2">
                                <button id="maintenance-finish-btn" class="w-full py-2 px-4 rounded-xl font-bold text-white shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600">
                                    Confirmar Limpeza Concluída
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 rounded-xl shadow-inner bg-gray-700 dark:bg-gray-300">
                        <p id="message-title" class="font-bold text-blue-400 dark:text-blue-700"></p>
                        <p id="system-message" class="mt-1 text-gray-300 dark:text-gray-800"></p>
                    </div>
                </div>

                <div class="p-8 rounded-3xl shadow-2xl bg-gray-800 bg-opacity-80 backdrop-blur-md dark:bg-gray-200 dark:bg-opacity-80">
                    <h2 class="text-3xl font-bold mb-6 text-white dark:text-gray-800">Estatísticas e Agendamento</h2>
                    
                    <div class="mb-6">
                        <p class="text-lg font-semibold mb-4 text-gray-300 dark:text-gray-700">Picos de Consumo (Simulado)</p>
                        <div id="usage-stats-container" class="grid grid-cols-4 sm:grid-cols-6 gap-2 text-center text-sm"></div>
                        <p class="text-sm font-medium text-gray-400 mt-4 dark:text-gray-600">
                            <span class="font-bold text-gray-300 dark:text-gray-700">Horários de menor movimento:</span> <span id="least-busy-hours"></span>
                        </p>
                    </div>

                    <div>
                        <p class="text-lg font-semibold mb-2 flex items-center space-x-2 text-gray-300 dark:text-gray-700">
                            <svg class="text-blue-500 w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="m9 16 2 2 4-4"/></svg>
                            <span>Agendar Limpeza</span>
                        </p>
                        <p class="text-sm text-gray-400 mb-4 dark:text-gray-600">
                            Selecione a data e hora para agendar a manutenção da caixa d'água.
                        </p>
                        <div class="relative">
                            <input type="text" id="scheduled-date-input" class="w-full p-3 pl-10 border rounded-xl bg-gray-700 text-white dark:bg-gray-300 dark:text-gray-900 border-gray-600 dark:border-gray-400 cursor-pointer" placeholder="Clique para escolher a data e hora">
                             <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                        </div>
                        <div class="flex flex-col space-y-4 mt-4">
                            <button id="schedule-submit-btn" class="w-full py-3 rounded-xl font-bold text-white shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-700 hover:to-cyan-600">
                                Agendar Limpeza
                            </button>
                            <p id="scheduled-date-message" class="text-sm text-green-400 mt-2 hidden font-medium"></p>
                        </div>
                    </div>
                </div>
            </main>
            
            <footer class="flex-shrink-0 mt-8 text-center text-gray-500 text-sm font-medium dark:text-gray-800">
                <p>&copy; 2025 Equipe Caminhos D'água - Todos os Direitos Reservados</p>
            </footer>
        </div>

        <!-- Tela de Logs -->
        <div id="log-screen" class="hidden z-10 w-full max-w-6xl mx-auto min-h-screen pt-12 pb-8">
            <header class="flex flex-col md:flex-row items-center justify-between mb-10 p-6 rounded-3xl shadow-2xl bg-gray-800 bg-opacity-80 backdrop-blur-md dark:bg-gray-200 dark:bg-opacity-80">
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <h1 class="text-3xl font-extrabold text-white dark:text-gray-800">Histórico de Logs</h1>
                </div>
                <div class="flex space-x-4">
                    <button id="clear-logs-btn" class="py-2 px-4 rounded-xl font-bold text-white shadow-lg transition-all duration-300 transform hover:scale-105 bg-red-600 hover:bg-red-700">
                        Limpar Logs
                    </button>
                    <button id="back-to-dashboard-btn" class="py-2 px-4 rounded-xl font-bold text-white shadow-lg transition-all duration-300 transform hover:scale-105 bg-blue-600 hover:bg-blue-700">
                        Voltar
                    </button>
                </div>
            </header>
            
            <div id="logs-container" class="space-y-4 p-8 rounded-3xl shadow-2xl bg-gray-800 bg-opacity-80 backdrop-blur-md dark:bg-gray-200 dark:bg-opacity-80">
                <p id="no-logs-message" class="text-center text-gray-400 dark:text-gray-600">Nenhum evento registrado ainda.</p>
            </div>
        </div>

        <!-- Tela de Configurações -->
        <div id="settings-screen" class="hidden z-10 p-8 md:p-12 rounded-3xl shadow-2xl max-w-lg w-full mx-4 transform transition-all duration-500 bg-gray-800 bg-opacity-80 backdrop-blur-md dark:bg-gray-200 dark:bg-opacity-80">
            <div class="text-center mb-6">
                <div class="flex items-center justify-center space-x-2 mb-2">
                    <svg class="text-blue-500 w-16 h-16" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    <h1 class="text-3xl font-extrabold text-white dark:text-gray-800">Configurações</h1>
                </div>
                <p class="text-sm font-medium text-gray-400 dark:text-gray-600">Ajuste as configurações da API.</p>
            </div>
            <div class="space-y-6">
                <div>
                    <label for="api-url-input" class="block text-sm font-bold mb-1 text-gray-300 dark:text-gray-700">URL da API</label>
                    <input type="text" id="api-url-input" class="w-full px-3 py-2 border border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white dark:bg-gray-300 dark:text-gray-900" placeholder="https://sua-api.replit.dev" />
                    <p id="api-save-message" class="text-green-400 text-sm font-semibold text-center mt-2 hidden"></p>
                </div>
                <div class="flex space-x-4">
                    <button id="save-api-btn" class="w-full py-3 rounded-xl font-bold text-white shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-700 hover:to-cyan-600">
                        Salvar e Reconectar
                    </button>
                    <button id="back-to-dashboard-from-settings-btn" class="w-full py-3 rounded-xl font-bold text-gray-800 dark:text-white shadow-lg transition-all duration-300 transform hover:scale-105 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500">
                        Voltar
                    </button>
                </div>
            </div>
        </div>

    </div>
    
    <!-- Flatpickr (Calendário) JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>

    <script>
        // --- Estado Inicial da Aplicação ---
        const initialState = {
            isAuthenticated: false,
            isDarkMode: true,
            apiUrl: 'https://4729f3c9-ba25-4482-b1df-8b6c892d63c4-00-2m7uq6359lv1d.kirk.replit.dev',
            pumpStatus: false,
            valveStatus: false,
            maintenanceMode: false,
            scheduledDate: '',
            message: 'Sistema pronto para operar.',
            usageStats: {
                '00h': 10, '01h': 8, '02h': 5, '03h': 6, '04h': 7, 
                '05h': 12, '06h': 18, '07h': 35, '08h': 50, '09h': 65, 
                '10h': 70, '11h': 60, '12h': 55, '13h': 50, '14h': 45, 
                '15h': 40, '16h': 35, '17h': 30, '18h': 45, '19h': 60, 
                '20h': 50, '21h': 30, '22h': 20, '23h': 15
            },
            logs: [],
            registeredUsers: [{ username: 'SENAI4.0', password: 'carecacabuloso' }]
        };
        let state = {};
        let isConnectedToAPI = false;
        const REGISTRATION_TOKEN = '251206';
        let apiStatusInterval = null;
        let maintenanceCheckInterval = null;
        let flatpickrInstance = null;

        // --- Funções de Armazenamento ---
        const saveStateToLocalStorage = () => {
            const stateToSave = { ...state };
            delete stateToSave.isAuthenticated;
            localStorage.setItem('waterTankAppState', JSON.stringify(stateToSave));
        };

        const loadStateFromLocalStorage = () => {
            const savedState = localStorage.getItem('waterTankAppState');
            state = savedState ? { ...initialState, ...JSON.parse(savedState) } : { ...initialState };
        };

        // --- Elementos do DOM ---
        const getEl = (id) => document.getElementById(id);
        const body = document.body;
        const loginScreen = getEl('login-screen');
        const registerScreen = getEl('register-screen');
        const dashboardScreen = getEl('dashboard-screen');
        const logScreen = getEl('log-screen');
        const settingsScreen = getEl('settings-screen');
        const themeToggleBtn = getEl('theme-toggle');
        const sunIcon = getEl('sun-icon');
        const moonIcon = getEl('moon-icon');
        const showRegisterBtn = getEl('show-register-btn');
        const showLoginBtn = getEl('show-login-btn');
        const loginForm = getEl('login-form');
        const usernameInput = getEl('username-input');
        const passwordInput = getEl('password-input');
        const loginError = getEl('login-error');
        const registerForm = getEl('register-form');
        const registerUsernameInput = getEl('register-username-input');
        const registerPasswordInput = getEl('register-password-input');
        const registerPasswordConfirmInput = getEl('register-password-confirm-input');
        const registerTokenInput = getEl('register-token-input');
        const registerError = getEl('register-error');
        const waterLevelBar = getEl('water-level-bar');
        const nivelAgua = getEl('nivelAgua');
        const pumpStatusCard = getEl('pump-status-card');
        const statusBomba = getEl('statusBomba');
        const valveStatusCard = getEl('valve-status-card');
        const statusRegistro = getEl('statusRegistro');
        const maintenanceModeCard = getEl('maintenance-mode-card');
        const maintenanceModeText = getEl('maintenance-mode-text');
        const maintenanceToggle = getEl('maintenance-toggle');
        const maintenanceControls = getEl('maintenance-controls');
        const maintenanceFinishBtn = getEl('maintenance-finish-btn');
        const systemMessage = getEl('system-message');
        const messageTitle = getEl('message-title');
        const usageStatsContainer = getEl('usage-stats-container');
        const leastBusyHoursSpan = getEl('least-busy-hours');
        const scheduledDateInput = getEl('scheduled-date-input');
        const scheduleSubmitBtn = getEl('schedule-submit-btn');
        const scheduledDateMessage = getEl('scheduled-date-message');
        const datetimeDisplay = getEl('datetime-display');
        const viewLogsBtn = getEl('view-logs-btn');
        const backToDashboardBtn = getEl('back-to-dashboard-btn');
        const logsContainer = getEl('logs-container');
        const clearLogsBtn = getEl('clear-logs-btn');
        const noLogsMessage = getEl('no-logs-message');
        const toggleBomba = getEl('toggleBomba');
        const toggleRegistro = getEl('toggleRegistro');
        const connectionDot = getEl('connection-dot');
        const connectionText = getEl('connection-text');
        const settingsBtn = getEl('settings-btn');
        const apiUrlInput = getEl('api-url-input');
        const saveApiBtn = getEl('save-api-btn');
        const apiSaveMessage = getEl('api-save-message');
        const backToDashboardFromSettingsBtn = getEl('back-to-dashboard-from-settings-btn');
        const flowDot = getEl('flow-dot');
        const flowText = getEl('flow-text');
        const passwordRequirements = getEl('password-requirements');
        const passwordValidIcon = getEl('password-valid-icon');
        const passwordMatchIcon = getEl('password-match-icon');
        const registerSubmitBtn = getEl('register-submit-btn');

        // --- Funções de UI e Utilitários ---
        const addLog = (message) => {
            const timestamp = new Date().toLocaleString('pt-BR');
            state.logs.unshift({ timestamp, message });
            saveStateToLocalStorage();
        };

        const updateDateTime = () => {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            datetimeDisplay.textContent = now.toLocaleDateString('pt-BR', options);
        };
        
        const showScreen = (screenId) => {
            [loginScreen, registerScreen, dashboardScreen, logScreen, settingsScreen].forEach(s => s.classList.add('hidden'));
            getEl(screenId).classList.remove('hidden');
        };

        const updateWaterLevelUI = (level) => {
            const levelToPercentage = { 0: 0, 1: 15, 2: 40, 3: 70, 4: 100 };
            const percentage = levelToPercentage[level] ?? 0;

            nivelAgua.textContent = `${percentage}%`;
            waterLevelBar.style.width = `${percentage}%`;

            if (percentage <= 20) {
                waterLevelBar.className = 'h-full rounded-full bg-gradient-to-r from-red-600 to-red-500';
            } else if (percentage <= 50) {
                waterLevelBar.className = 'h-full rounded-full bg-gradient-to-r from-yellow-500 to-yellow-400';
            } else {
                waterLevelBar.className = 'h-full rounded-full bg-gradient-to-r from-blue-500 to-cyan-400';
            }
        };

        const updateUI = () => {
            body.classList.toggle('dark', state.isDarkMode);
            body.classList.toggle('bg-gray-900', state.isDarkMode);
            body.classList.toggle('text-gray-100', state.isDarkMode);
            body.classList.toggle('bg-gray-100', !state.isDarkMode);
            body.classList.toggle('text-gray-800', !state.isDarkMode);

            sunIcon.classList.toggle('hidden', !state.isDarkMode);
            moonIcon.classList.toggle('hidden', state.isDarkMode);
            
            themeToggleBtn.classList.toggle('bg-gray-800', state.isDarkMode);
            themeToggleBtn.classList.toggle('text-white', state.isDarkMode);
            themeToggleBtn.classList.toggle('bg-gray-200', !state.isDarkMode);
            themeToggleBtn.classList.toggle('text-gray-800', !state.isDarkMode);

            maintenanceModeCard.className = `p-6 rounded-2xl shadow-lg transition-all duration-300 transform hover:scale-[1.01] ${state.maintenanceMode ? 'bg-red-800 status-red-glow' : 'bg-gray-700 dark:bg-gray-300'}`;
            maintenanceModeText.textContent = state.maintenanceMode ? 'ATIVADO' : 'DESLIGADO';
            maintenanceModeText.className = `text-xl font-bold ${state.maintenanceMode ? 'text-red-400' : 'text-gray-400 dark:text-gray-600'}`;
            maintenanceToggle.checked = state.maintenanceMode;
            maintenanceControls.classList.toggle('hidden', !state.maintenanceMode);
            
            [valveStatusCard, toggleRegistro].forEach(el => {
                el.classList.toggle('disabled-element', state.maintenanceMode);
            });
            
            maintenanceToggle.disabled = state.maintenanceMode;

            renderUsageStats();
            renderLogs();

            if (state.scheduledDate) {
                const formattedDate = new Date(state.scheduledDate).toLocaleString('pt-BR');
                scheduledDateMessage.textContent = `Limpeza agendada para ${formattedDate}.`;
                scheduledDateMessage.classList.remove('hidden');
            } else {
                scheduledDateMessage.classList.add('hidden');
            }
        };

        const renderUsageStats = () => {
            usageStatsContainer.innerHTML = '';
            const sortedStats = Object.entries(state.usageStats).sort(([hourA], [hourB]) => parseInt(hourA) - parseInt(hourB));
            sortedStats.forEach(([hour, usage]) => {
                const div = document.createElement('div');
                div.className = `p-2 rounded-xl shadow-md transition-all duration-300 usage-tile font-medium transform hover:scale-110 ${usage > 50 ? 'bg-red-800 text-red-200' : 'bg-gray-700 text-gray-200 dark:bg-gray-400 dark:text-gray-800'}`;
                div.innerHTML = `<span class="block font-bold">${hour}</span><span class="text-xs">${usage}%</span>`;
                usageStatsContainer.appendChild(div);
            });
            const leastBusyHours = Object.entries(state.usageStats).sort(([, usageA], [, usageB]) => usageA - usageB).slice(0, 3).map(([hour]) => hour).join(', ');
            leastBusyHoursSpan.textContent = leastBusyHours;
        };

        const renderLogs = () => {
            logsContainer.innerHTML = '';
            if (state.logs.length === 0) {
                logsContainer.appendChild(noLogsMessage);
            } else {
                state.logs.forEach(log => {
                    const logItem = document.createElement('div');
                    logItem.className = 'p-4 rounded-xl shadow-md border border-gray-700 dark:border-gray-400 bg-gray-700 dark:bg-gray-300 transition-all duration-300 transform hover:scale-[1.01]';
                    logItem.innerHTML = `<p class="text-sm text-gray-400 dark:text-gray-600">${log.timestamp}</p><p class="mt-1 font-medium text-gray-200 dark:text-gray-900">${log.message}</p>`;
                    logsContainer.appendChild(logItem);
                });
            }
        };
        
        const checkScheduledMaintenance = () => {
            if (state.scheduledDate && !state.maintenanceMode) {
                const now = new Date();
                const scheduledTime = new Date(state.scheduledDate);
                if (now.getTime() >= scheduledTime.getTime()) {
                    enviarComando('manutencao', 'on');
                }
            }
        };
        
        const setupPasswordToggles = () => {
            document.querySelectorAll('.show-password-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const input = button.parentElement.querySelector('input');
                    const showIcon = button.querySelector('.show-icon');
                    const hideIcon = button.querySelector('.hide-icon');
                    if (input.type === 'password') {
                        input.type = 'text';
                        showIcon.classList.add('hidden');
                        hideIcon.classList.remove('hidden');
                    } else {
                        input.type = 'password';
                        showIcon.classList.remove('hidden');
                        hideIcon.classList.add('hidden');
                    }
                });
            });
        };

        // --- Gerenciadores de Eventos ---
        themeToggleBtn.addEventListener('click', () => {
            state.isDarkMode = !state.isDarkMode;
            saveStateToLocalStorage();
            updateUI();
        });

        showRegisterBtn.addEventListener('click', (e) => { e.preventDefault(); showScreen('register-screen'); });
        showLoginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            showScreen('login-screen');
            registerForm.reset();
            registerError.classList.add('hidden');
            loginError.classList.remove('text-green-400');
            loginError.classList.add('text-red-400');
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const user = state.registeredUsers.find(u => u.username === usernameInput.value && u.password === passwordInput.value);
            if (user) {
                state.isAuthenticated = true;
                addLog(`Usuário "${user.username}" logado com sucesso.`);
                showScreen('dashboard-screen');
                saveStateToLocalStorage();
            } else {
                loginError.textContent = 'Usuário ou senha incorretos.';
                loginError.classList.remove('text-green-400', 'hidden');
                loginError.classList.add('text-red-400');
            }
        });
        
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const [username, password, token] = [registerUsernameInput.value, registerPasswordInput.value, registerTokenInput.value];
            registerError.classList.add('hidden');

            if (state.registeredUsers.some(u => u.username === username)) {
                registerError.textContent = 'Nome de usuário já existe.';
                registerError.classList.remove('hidden');
                return;
            }
            if (token !== REGISTRATION_TOKEN) {
                registerError.textContent = 'Token de segurança incorreto.';
                registerError.classList.remove('hidden');
                return;
            }

            state.registeredUsers.push({ username, password });
            addLog(`Novo usuário "${username}" cadastrado.`);
            saveStateToLocalStorage();
            loginError.textContent = `Cadastro realizado! Faça login com "${username}".`;
            loginError.classList.remove('text-red-400', 'hidden');
            loginError.classList.add('text-green-400');
            showScreen('login-screen');
        });
        
        scheduleSubmitBtn.addEventListener('click', () => {
            const selectedDates = flatpickrInstance.selectedDates;
            if (selectedDates.length > 0) {
                const date = selectedDates[0];
                state.scheduledDate = date.toISOString();
                const formattedDate = date.toLocaleString('pt-BR');
                state.message = `Limpeza agendada para: ${formattedDate}.`;
                addLog(`Limpeza agendada para ${formattedDate}.`);
                saveStateToLocalStorage();
                updateUI();
            } else {
                state.message = 'Por favor, selecione uma data e hora válidas.';
                updateUI();
            }
        });
        
        viewLogsBtn.addEventListener('click', () => showScreen('log-screen'));
        backToDashboardBtn.addEventListener('click', () => showScreen('dashboard-screen'));
        settingsBtn.addEventListener('click', () => {
            apiUrlInput.value = state.apiUrl;
            apiSaveMessage.classList.add('hidden');
            showScreen('settings-screen');
        });
        backToDashboardFromSettingsBtn.addEventListener('click', () => showScreen('dashboard-screen'));

        clearLogsBtn.addEventListener('click', () => {
            state.logs = [];
            addLog("Logs do sistema limpos.");
            saveStateToLocalStorage();
            renderLogs();
        });

        saveApiBtn.addEventListener('click', () => {
            const newApiUrl = apiUrlInput.value.trim();
            if (newApiUrl) {
                state.apiUrl = newApiUrl;
                saveStateToLocalStorage();
                apiSaveMessage.textContent = 'API salva! Reconectando...';
                apiSaveMessage.classList.remove('hidden');
                setTimeout(() => apiSaveMessage.classList.add('hidden'), 3000);
                conectarComAPI();
            }
        });
        
        // --- Inicialização da Aplicação ---
        window.addEventListener('load', () => {
            loadStateFromLocalStorage();
            setupPasswordToggles();
            setupPasswordValidation();

            flatpickr.localize(flatpickr.l10ns.pt);
            flatpickrInstance = flatpickr("#scheduled-date-input", {
                enableTime: true,
                dateFormat: "d/m/Y H:i",
                minDate: "today",
                time_24hr: true
            });
            
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            if (maintenanceCheckInterval) clearInterval(maintenanceCheckInterval);
            maintenanceCheckInterval = setInterval(checkScheduledMaintenance, 60000);

            if (state.isAuthenticated) {
                showScreen('dashboard-screen');
            } else {
                showScreen('login-screen');
            }
            updateUI();
            conectarComAPI();
        });
    </script>

    <!-- Script para Integração com a API e Validação -->
    <script>
        async function enviarComando(componente, acao) {
            messageTitle.textContent = "COMANDO";
            systemMessage.textContent = `Enviando comando para ${componente}: ${acao}...`;
            addLog(`Enviando comando: ${componente} = ${acao}.`);
            
            try {
                const commandUrl = `${state.apiUrl}/comando?${componente}=${acao}`;
                const response = await fetch(commandUrl);
                if (!response.ok) throw new Error(`Erro ${response.status}`);
                console.log(`Comando enviado: ${componente}=${acao}`);
                await buscarStatus();
            } catch (error) {
                console.error(`Falha ao enviar comando para a API: ${error.message}`);
                addLog(`ERRO: Falha ao enviar comando "${componente}=${acao}".`);
                messageTitle.textContent = "ALERTA";
                systemMessage.textContent = `Falha ao enviar comando para ${componente}.`;
            }
        }

        async function buscarStatus() {
            try {
                const response = await fetch(`${state.apiUrl}/status`);
                if (!response.ok) throw new Error(`Erro ${response.status}`);
                
                const data = await response.json();

                if (!isConnectedToAPI) {
                    isConnectedToAPI = true;
                    connectionDot.classList.remove('bg-yellow-500', 'animate-pulse', 'bg-red-500');
                    connectionDot.classList.add('bg-green-500');
                    connectionText.textContent = 'Conexão OK';
                }
                
                const registroAberto = data.registro === 1;
                const maintenanceMode = data.manutencao === 1;
                const fluxoDetectado = data.fluxo > 0;
                const bombaLigada = data.bomba === 1;

                if (state.pumpStatus === true && bombaLigada === false && !maintenanceMode) {
                    messageTitle.textContent = 'ALERTA';
                    systemMessage.textContent = "Bomba não ligou. Verifique o fluxo de água.";
                    addLog("Tentativa de ligar a bomba falhou (sem fluxo).");
                } else if (fluxoDetectado && !maintenanceMode) {
                    messageTitle.textContent = 'INFO';
                    systemMessage.textContent = "Fluxo de água detectado. Sistema pronto para operar.";
                } else if (!fluxoDetectado && !maintenanceMode) {
                    messageTitle.textContent = 'ALERTA';
                    systemMessage.textContent = "Sem fluxo de água. Bomba desativada por segurança.";
                }
                
                state.pumpStatus = bombaLigada;
                state.valveStatus = registroAberto;
                state.maintenanceMode = maintenanceMode;

                flowDot.classList.toggle('bg-green-500', fluxoDetectado);
                flowDot.classList.toggle('bg-red-500', !fluxoDetectado);
                flowText.textContent = fluxoDetectado ? 'DETECTADO' : 'NÃO DETECTADO';
                flowText.classList.toggle('text-green-400', fluxoDetectado);
                flowText.classList.toggle('text-red-400', !fluxoDetectado);

                const isPumpDisabled = maintenanceMode;
                pumpStatusCard.classList.toggle('disabled-element', isPumpDisabled);
                toggleBomba.disabled = isPumpDisabled;

                updateWaterLevelUI(data.nivel);
                
                toggleBomba.checked = bombaLigada;
                statusBomba.textContent = bombaLigada ? 'LIGADA' : 'DESLIGADA';
                statusBomba.classList.toggle('text-green-500', bombaLigada);
                statusBomba.classList.toggle('text-red-500', !bombaLigada);
                pumpStatusCard.className = `p-6 rounded-2xl shadow-lg transition-all duration-300 transform hover:scale-105 ${bombaLigada ? 'bg-emerald-800 status-glow' : 'bg-red-800 status-red-glow'}`;
                
                toggleRegistro.checked = registroAberto;
                statusRegistro.textContent = registroAberto ? 'ABERTO' : 'FECHADO';
                statusRegistro.classList.toggle('text-green-400', registroAberto);
                statusRegistro.classList.toggle('text-red-500', !registroAberto);
                valveStatusCard.className = `p-6 rounded-2xl shadow-lg transition-all duration-300 transform hover:scale-105 ${registroAberto ? 'bg-emerald-800 status-glow' : 'bg-red-800 status-red-glow'}`;
                
                updateUI();

            } catch (error) {
                console.error(`Falha ao buscar status da API: ${error.message}`);
                if (isConnectedToAPI) {
                    isConnectedToAPI = false;
                    connectionDot.classList.remove('bg-yellow-500', 'animate-pulse', 'bg-green-500');
                    connectionDot.classList.add('bg-red-500');
                    connectionText.textContent = 'Sem Conexão';
                    if (!state.maintenanceMode) {
                        messageTitle.textContent = "ALERTA";
                        systemMessage.textContent = 'Falha na comunicação com a API.';
                    }
                }
            }
        }
        
                async function conectarComAPI() {
            if (apiStatusInterval) clearInterval(apiStatusInterval);

            connectionDot.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
            connectionText.textContent = 'Procurando...';
            
            await buscarStatus();
            // --- MUDANÇA FINAL: Intervalo mais rápido para zerar o delay ---
            apiStatusInterval = setInterval(buscarStatus, 250); // De 750ms para 500ms
        }


        // --- EVENT LISTENERS DOS CONTROLES ---
        toggleBomba.addEventListener('change', (e) => {
            state.pumpStatus = e.target.checked;
            enviarComando('bomba', e.target.checked ? 'on' : 'off');
        });
        toggleRegistro.addEventListener('change', (e) => {
            state.valveStatus = e.target.checked;
            enviarComando('registro', e.target.checked ? 'on' : 'off');
        });
        maintenanceToggle.addEventListener('change', (e) => {
            const isActivating = e.target.checked;
            if (isActivating) {
                enviarComando('bomba', 'off');
                enviarComando('registro', 'off');
            }
            enviarComando('manutencao', isActivating ? 'on' : 'off');
        });
        maintenanceFinishBtn.addEventListener('click', () => {
             enviarComando('manutencao', 'off');
             enviarComando('registro', 'on');
             enviarComando('bomba', 'on');
             messageTitle.textContent = 'INFO';
             systemMessage.textContent = 'Manutenção finalizada. Reativando automação...';
        });

        function setupPasswordValidation() {
            const reqs = {
                length: { el: getEl('req-length'), regex: /.{8,}/ },
                uppercase: { el: getEl('req-uppercase'), regex: /[A-Z]/ },
                lowercase: { el: getEl('req-lowercase'), regex: /[a-z]/ },
                number: { el: getEl('req-number'), regex: /[0-9]/ },
                special: { el: getEl('req-special'), regex: /[!@#$%^&*]/ }
            };
            let passwordIsValid = false;
            let passwordsMatch = false;

            const checkAllValidations = () => {
                const allValid = passwordIsValid && passwordsMatch && registerUsernameInput.value.trim() !== '' && registerTokenInput.value.trim() !== '';
                registerSubmitBtn.disabled = !allValid;
            };

            registerPasswordInput.addEventListener('focus', () => {
                passwordRequirements.classList.remove('hidden');
            });

            registerPasswordInput.addEventListener('input', () => {
                const password = registerPasswordInput.value;
                let allReqsMet = true;

                for (const key in reqs) {
                    const req = reqs[key];
                    const isValid = req.regex.test(password);
                    req.el.classList.toggle('text-green-400', isValid);
                    req.el.classList.toggle('text-red-400', !isValid);
                    req.el.querySelector('span').textContent = isValid ? '✓' : '✗';
                    if (!isValid) allReqsMet = false;
                }

                passwordIsValid = allReqsMet;
                passwordValidIcon.innerHTML = allReqsMet ? '<span class="text-green-400">✓</span>' : '<span class="text-red-400">✗</span>';
                
                const confirmPassword = registerPasswordConfirmInput.value;
                passwordsMatch = password !== '' && password === confirmPassword;
                passwordMatchIcon.innerHTML = passwordsMatch ? '<span class="text-green-400">✓</span>' : (confirmPassword ? '<span class="text-red-400">✗</span>' : '');

                checkAllValidations();
            });

            registerPasswordConfirmInput.addEventListener('input', () => {
                const password = registerPasswordInput.value;
                const confirmPassword = registerPasswordConfirmInput.value;
                passwordsMatch = password !== '' && password === confirmPassword;
                passwordMatchIcon.innerHTML = passwordsMatch ? '<span class="text-green-400">✓</span>' : (confirmPassword ? '<span class="text-red-400">✗</span>' : '');
                checkAllValidations();
            });

            [registerUsernameInput, registerTokenInput].forEach(input => {
                input.addEventListener('input', checkAllValidations);
            });

            checkAllValidations();
        }
    </script>
</body>
</html>
